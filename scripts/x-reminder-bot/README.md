# X (Twitter) 監視Bot

指定したX（旧Twitter）アカウントのポストを監視し、条件に応じてDiscordに通知するBotです。

**注意**: このBotはWebスクレイピング（ログイン機能付き）を使用してポストを取得します。

**⚠️ 重要な警告**:
- この方法はTwitterの利用規約に違反する可能性があります
- アカウントが凍結されるリスクがあります
- テスト用または専用のアカウントを使用することを強く推奨します
- 自己責任でご利用ください

## 機能

- 1時間ごとに指定アカウントのポストをチェック
- 平日（月〜金）の17:00〜22:00の間に動作
- その日の「店内状況」を含むポストの有無をチェック
- ポストがある場合: 件数を報告
- ポストがない場合: メンション付きでリマインダーを送信

## セットアップ

### 1. 依存パッケージのインストール

```bash
npm install
```

### 2. Twitterアカウントの準備

**⚠️ 重要**: メインアカウントではなく、テスト用または専用のアカウントを使用してください。

このBotで使用するTwitterアカウントを準備します：
- 既存のアカウントを使用、または新規作成
- ログイン用のメールアドレス（または電話番号）とパスワードをメモ
- 2段階認証は無効にしておくことを推奨（有効な場合、ログインが失敗する可能性があります）

### 3. Discord Webhook URLの取得

1. Discordのチャンネル設定を開く
2. 「連携サービス」→「ウェブフック」を選択
3. 「新しいウェブフック」を作成してURLをコピー

### 4. Discord ロールIDの取得（メンション用）

メンション通知を機能させるには、ロールの**数値ID**が必要です：

1. Discordの **ユーザー設定** → **詳細設定** → **開発者モード** をONにする
2. サーバー設定 → ロール → メンションしたいロールを右クリック → **IDをコピー**
3. コピーしたID（例: `1234567890123456789`）を環境変数に設定

**重要**: ロール名（例: `むさぽ神田メンバー`）ではメンション通知が届きません。必ず数値IDを使用してください。

### 5. 環境変数の設定

`.env.sample`を`.env`にコピーして、必要な情報を入力してください:

```bash
cp .env.sample .env
```

`.env`ファイルを編集:

```env
# Discord Webhook URL
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...

# Twitterログイン情報
TWITTER_LOGIN_EMAIL=your_email_or_phone@example.com
TWITTER_LOGIN_PASSWORD=your_password_here

# 監視対象のTwitterユーザー名（@なし）
TWITTER_USERNAME=634poker_kanda

# Discord メンション用のロールID（数値のIDを指定）
DISCORD_ROLE_ID=1234567890123456789
```

## ビルドと実行

### 開発モード

```bash
npm run dev
```

### 本番モード

```bash
npm run build
npm start
```

### デバッグモード

動作確認のためのデバッグモードを用意しています。

#### 方法1: 現在時刻でテスト（稼働時間チェックをスキップ）

```bash
npm run debug
```

このコマンドは：
- 稼働時間（平日17-22時）のチェックをスキップ
- すぐに1回だけ実行して終了
- 取得した全ポストをログに表示

#### 方法2: 特定の時刻を指定してテスト

```bash
DEBUG_TIME="2026-02-03T18:30:00+09:00" npm run debug:time
```

または、`.env`ファイルに追加：

```env
DEBUG_MODE=true
DEBUG_TIME=2026-02-03T18:30:00+09:00
```

**時刻の指定方法:**
- ISO 8601形式で指定
- 必ず`+09:00`（JST）を付ける
- 例: `2026-02-03T18:30:00+09:00` = 2026年2月3日 18時30分（JST）

**ユースケース:**
```bash
# 平日18時をシミュレート（稼働時間内）
DEBUG_TIME="2026-02-03T18:00:00+09:00" npm run debug:time

# 平日15時をシミュレート（稼働時間外）
DEBUG_TIME="2026-02-03T15:00:00+09:00" npm run debug:time

# 土曜日をシミュレート（休日）
DEBUG_TIME="2026-02-07T18:00:00+09:00" npm run debug:time
```

## 監視ルール

### 稼働時間
- 平日（月〜金）
- **17:00、18:00、19:00、20:00、21:00、22:00（JST）**にチェック
- 毎時0分ちょうどに実行されます
- **注意**: すべての時刻判定は日本標準時（JST / UTC+9）で行われます

### チェック条件
- その日（0時以降）に投稿された「店内状況」を含むポストの有無

### 通知内容

#### ポストがある場合
```
✅ 店内状況ポストX件されてます
```

#### ポストがない場合
```
⚠️ @むさぽ神田メンバー まだ店内状況ポストされてないけど大丈夫？ https://634poker-kanda.com/waitinglist 入れるの忘れずに
```

## ログ

実行ログは`logs/`ディレクトリに日付ごとに保存されます:
- ファイル名: `bot-YYYY-MM-DD.log`

## デーモン化（systemd）

本番環境で常時起動させる場合は、systemdサービスとして登録できます:

```ini
[Unit]
Description=X Reminder Bot
After=network.target

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/x-reminder-bot
ExecStart=/usr/bin/node dist/index.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

## トラブルシューティング

### Xのツイート取得エラー

- ログイン情報（メールアドレス/電話番号とパスワード）が正しく設定されているか確認してください
- Twitterアカウントが凍結されていないか確認してください
- 2段階認証が有効になっている場合は無効にしてください
- ログインページの構造が変更された可能性があります（Twitterはページ構造を頻繁に変更します）
- ユーザー名が正しいか確認してください（@マークは不要です）
- ログファイル（`logs/`）を確認してエラー内容を確認してください

### アカウント凍結のリスク

- Botによる自動ログインはTwitterの利用規約に違反する可能性があります
- アカウントが凍結された場合、復旧は困難です
- メインアカウントではなく、テスト用アカウントを使用してください

### Discord通知が届かない

- Webhook URLが正しいか確認してください
- Webhookが削除されていないか確認してください

## ライセンス

MIT
